<div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-100 to-blue-100 py-6 px-4 sm:px-8 lg:px-20">
    <form  #formRef="ngForm" [formGroup]="form">
        <div class="max-w-3xl mx-auto rounded-lg bg-white shadow-2xl border-2 border-indigo-100">

            <!-- Form title and description -->
            <div class="bg-gradient-to-r from-purple-800 via-purple-700 to-indigo-800 p-6 mb-4 rounded-t-lg">
                <h1 class="text-white text-3xl font-medium tracking-wide">{{ formPreviewData.title }}</h1>
                <h4 class="text-white text-md" [ngClass]="{'pt-4': formPreviewData.description}">{{ formPreviewData.description }}</h4>
            </div>
            <div formArrayName="sections">

                <ng-container *ngFor="let section of sections; let sIdx = index">

                    <div *ngIf="sIdx === currentSectionIndex" [formGroupName]="sIdx" class="p-4">

                        <!-- Section title and description -->
                        <div *ngIf="currentSectionIndex != 0"
                            class="p-4 mb-5 text-purple-800 border-l-8 border-l-purple-800 shadow-md shadow-purple-200">
                            <h2 class="text-2xl font-medium ">{{ section.sectionTitle }}</h2>
                            <h4 class="text-md text-purple-700" [ngClass]="{'pt-2': section.sectionDescription}">
                                {{ section.sectionDescription }}
                            </h4>
                        </div>
                        
                        <div formArrayName="questions" class="px-4">
                            <div *ngFor="let question of section.questions; let qIdx = index" [formGroupName]="qIdx"
                                class="shadow-lg rounded-md border border-gray-200 p-6 mb-3">
                                    <div class="text-lg font-medium mb-5">
                                        <span>{{ question.questionText }}</span>
                                        <span *ngIf="question.required" class="text-red-600 ml-1">*</span>
                                    </div>
                                    <div *ngIf="question.questionDecription" class="text-base font-extralight mb-5">
                                        <span>{{ question.questionDecription }}</span>
                                    </div>

                                    <div [ngSwitch]="question.type">

                                        <!-- Short text -->
                                        <div *ngSwitchCase="'shortText'">
                                            <input type="text" placeholder="Your answer" formControlName="answer"
                                                class="w-1/2 p-1 bg-transparent border-b-2 border-gray-300 focus:outline-none focus:border-purple-700">
                                        </div>

                                        <!-- Paragraph -->
                                        <div *ngSwitchCase="'paragraph'">
                                            <textarea #textArea rows="1" placeholder="Your answer" formControlName="answer"
                                                (input)="textArea.style.height = 'auto'; textArea.style.height = textArea.scrollHeight + 'px';"
                                                (focus)="textArea.setSelectionRange(0, 0)"
                                                class="w-full p-1 bg-transparent border-b-2 border-gray-300 focus:outline-none focus:border-purple-700 resize-none overflow-hidden"
                                            ></textarea>
                                        </div>

                                        <!-- Multiple choice -->
                                        <div *ngSwitchCase="'multipleChoice'" class="space-y-3">
                                            <div *ngFor="let option of question.options; let opIdx = index">
                                                <label class="flex items-center gap-2 cursor-pointer relative">
                                                    <input type="radio" [value]="option.label" formControlName="answer" name="answer"
                                                        (change)="onAnswerSelected(option, question)" 
                                                        class="cursor-pointer peer hidden">
                                                    <div class="w-5 h-5 rounded-full border-2 border-gray-400 peer-checked:border-purple-600 flex items-center justify-center"></div>
                                                    <div class="w-3 h-3 absolute left-1 bg-purple-700 rounded-full opacity-0 scale-0 peer-checked:opacity-100 peer-checked:scale-100 transition-all duration-200 ease-out"></div>
                                                    <span>{{ option.label }}</span>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Checkboxes -->
                                        <div *ngSwitchCase="'checkboxes'" >
                                            <div formArrayName="answer" class="space-y-3">
                                                <div *ngFor="let option of question.options; let opIdx = index">
                                                    <label class="flex items-center gap-2 cursor-pointer relative">
                                                        <input type="checkbox" [formControlName]="opIdx"
                                                            [checked]="question.answer.value.includes(option.label)"
                                                            (change)="onCheckboxChange($event, question.answer)"
                                                            class="cursor-pointer peer hidden">
                                                        <div class="w-5 h-5 rounded-sm border-2 border-gray-400 peer-checked:border-purple-700 bg-transparent peer-checked:bg-purple-700 transition-all duration-300 flex items-center justify-center"></div>
                                                        
                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"
                                                            class="absolute w-5 h-5 text-white scale-x-0 peer-checked:scale-x-100 transition-transform duration-400" >
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                                        </svg>
                                                        <span>{{ option.label }}</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Dropdown -->
                                        <div *ngSwitchCase="'dropdown'">
                                            <ng-container *ngIf="true">
                                                <div class="relative w-56" #dropdownBox>
                                                    <!-- Selected Value -->
                                                    <div (click)="dropdownOpen[qIdx] = !dropdownOpen[qIdx]"
                                                        class="flex justify-between items-center bg-transparent border-2 border-gray-300 px-3 py-2 shadow-sm rounded cursor-pointer">
                                                        <span [ngClass]="{'text-gray-400': !question.answer}">{{ question.answer || 'Select an option' }}</span> 
                                                        <span class="text-gray-500 text-xl">‚è∑</span>
                                                    </div>
                                            
                                                    <!-- Dropdown Menu -->
                                                    <div *ngIf="dropdownOpen[qIdx]"
                                                        class="absolute z-50 left-0 top-full w-full rounded shadow-md bg-indigo-50 border">
                                                        <ul class="flex flex-col text-gray-800">
                                                            <li *ngFor="let option of question.options"
                                                                (click)="question.answer = option.label; dropdownOpen[qIdx] = false"
                                                                (click)="onAnswerSelected(option, question)"
                                                                class="hover:bg-indigo-200 px-4 py-2 cursor-pointer"
                                                                [ngClass]="{'bg-indigo-100': option.label === question.answer}">
                                                                {{ option.label }}
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </div>

                                        <!-- Rating -->
                                        <div *ngSwitchCase="'rating'">
                                            <!-- <div class="flex space-x-2">
                                                <label *ngFor="let i of getRatingRange(question)" class="cursor-pointer">
                                                    <input 
                                                        type="radio" 
                                                        name="rating{{currentSectionIndex}}{{qIdx}}" 
                                                        class="hidden"
                                                    >
                                                    <span class="text-2xl hover:text-yellow-500">&#9734;</span>
                                                </label>
                                            </div> -->
                                            <div class="flex flex-col items-start sm:flex-row sm:justify-center gap-5">
                                                <label *ngFor="let i of getRatingRange(question)"
                                                    class="flex flex-row sm:flex-col gap-2 justify-center items-center">
                                                    <span class="text-sm text-gray-600">{{ i }}</span>
                                                    <input type="radio" [value]="i" [(ngModel)]="question.answer" 
                                                        name="rating {{currentSectionIndex}}{{qIdx}}"
                                                        class="cursor-pointer peer hidden">
                                                    <button type="button" (click)="question.answer = i">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" class="text-gray-500"
                                                            [ngClass]="{
                                                                'text-yellow-400 fill-yellow-400': i <= question.answer,
                                                                'text-gray-400 fill-none': i > question.answer
                                                            }" 
                                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                            <polygon points="12 2 15 8 22 9 17 14 18 21 12 17 6 21 7 14 2 9 9 8" />
                                                        </svg>
                                                    </button>
                                                    
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Linear scale -->
                                        <div *ngSwitchCase="'linearScale'">
                                            <div class="flex flex-col items-start sm:flex-row sm:justify-center gap-5">
                                                <label *ngFor="let i of getScaleRange(question)" 
                                                    class="flex flex-row sm:flex-col gap-2 justify-center items-center relative cursor-pointer">
                                                    <span class="text-sm text-gray-600">{{ i }}</span>
                                                    <input type="radio" [value]="i" [(ngModel)]="question.answer" 
                                                        name="linearScale {{currentSectionIndex}}{{qIdx}}"
                                                        class="cursor-pointer peer hidden">
                                                    <div class="w-5 h-5 rounded-full border-2 border-gray-400 peer-checked:border-purple-600 flex items-center justify-center"></div>
                                                    <div class="w-3 h-3 absolute left-1 top-8 bg-purple-700 rounded-full opacity-0 scale-0 peer-checked:opacity-100 peer-checked:scale-100 transition-all duration-200 ease-out"></div>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Date -->
                                        <div *ngSwitchCase="'date'">
                                            <input type="date"
                                            [(ngModel)]="question.answer" name="date {{currentSectionIndex}}{{qIdx}}"
                                            class="w-56 p-1 bg-transparent border-b-2 border-gray-300 focus:outline-none focus:border-purple-700">
                                        </div>

                                        <!-- Time -->
                                        <div *ngSwitchCase="'time'">
                                            <input type="time"
                                            [(ngModel)]="question.answer" name="time {{currentSectionIndex}}{{qIdx}}"
                                            class="w-56 p-1 bg-transparent border-b-2 border-gray-300 focus:outline-none focus:border-purple-700">
                                        </div>
                                        
                                        <!-- MCQ grid -->
                                        <div *ngSwitchCase="'multipleChoiceGrid'">
                                            <table class="w-full border-separate border-spacing-y-2">

                                                <!-- Header row (Column names) -->
                                                <thead>
                                                    <tr class="border-b-2 border-gray-600">
                                                        <th class="py-2 px-4 border-b-2 border-gray-200"></th>
                                                        <th *ngFor="let column of question.columns"
                                                            class="py-2 px-4 text-center font-medium text-gray-700 border-b-2 border-gray-200">
                                                            {{ column }}
                                                        </th>
                                                    </tr>
                                                </thead>

                                                <!-- Question grid -->
                                                <tbody>
                                                    <tr *ngFor="let row of question.rows; let rowIdx = index" class="bg-violet-50 mb-2">
                                                        <th class="py-2 px-4 text-center font-medium text-gray-700">
                                                            {{ row }}
                                                        </th>
                                                        <td *ngFor="let column of question.columns; let colIdx = index" class="py-2 px-4 text-center font-medium">
                                                            <label class="flex items-center justify-center relative cursor-pointer">
                                                                <input type="radio" [value]="row + rowIdx + colIdx" [(ngModel)]="question.answer[rowIdx]" 
                                                                    (change)="selectMultipleChoiceGrid(question, row, column)"
                                                                    name="multipleChoiceGrid-{{ currentSectionIndex }}-{{ qIdx }}-{{ rowIdx }}"
                                                                    class="cursor-pointer peer hidden">
                                                                <div class="w-5 h-5 rounded-full border-2 border-gray-400 peer-checked:border-purple-600 flex items-center justify-center"></div>
                                                                <div class="w-3 h-3 absolute bg-purple-700 rounded-full opacity-0 scale-0 peer-checked:opacity-100 peer-checked:scale-100 transition-all duration-200 ease-out"></div>
                                                            </label>
                                                            
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <div *ngSwitchCase="'checkboxGrid'">
                                            <table class="w-full border-collapse">
                                            <thead>
                                                <tr>
                                                    <th class="border border-gray-300 py-2 px-4 text-left font-semibold text-gray-700"></th>
                                                    <th *ngFor="let column of question.columns"
                                                    class="border border-gray-300 py-2 px-4 font-semibold text-gray-700">
                                                        {{ column }}
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let row of question.rows">
                                                    <th class="border border-gray-300 py-2 px-4 text-left text-gray-600">{{row}}</th>
                                                    <td *ngFor="let column of question.columns" class="border border-gray-300 py-2 px-4 text-center">
                                                        <input 
                                                            type="checkbox" 
                                                            name="multipleChoiceGrid {{currentSectionIndex}}{{qIdx}}"
                                                            class="h-4 w-4"
                                                        >
                                                    </td>
                                                </tr>
                                            </tbody>
                                            </table>
                                        </div>

                                        <!-- File upload -->
                                        <div *ngSwitchCase="'file'">
                                            <input type="file" name="file {{currentSectionIndex}}{{qIdx}}">
                                        </div>


                                        <div *ngSwitchDefault>output2</div>
                                    </div> <!--SWITCH END-->
                            </div> <!--QUESTIONS FOR LOOP-->
                        </div>
                    </div>
                </ng-container>
            </div>   
        </div>

        <!-- FORM ACTION BUTTONS -->
        <div class="max-w-3xl mx-auto flex justify-between py-6 text-base">
            <div class="bg-gradient-to-tr rounded-md from-purple-600 to-indigo-600 p-0.5">
                <button (click)="confirmClearForm(formRef)"
                    class="px-6 py-2 text-purple-700 font-medium rounded-md bg-white hover:bg-indigo-50">
                    Clear form
                </button>
            </div>
            <div class="flex gap-2">
                <button (click)="gotoPreviousSection()"
                    *ngIf="currentSectionIndex > 0"
                    class="pr-6 pl-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-medium flex items-center
                    rounded-md hover:shadow-md hover:from-indigo-700 hover:to-purple-700 transition-all duration:300 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" class="-ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
                    </svg>
                    <span>Back</span> 
                </button>
                <button (click)="gotoNextSection()"
                    *ngIf="sections.length>1 
                        && sections[currentSectionIndex].nextSection < sections.length 
                        && sections[currentSectionIndex].nextSection != -1;
                    else dosubmit"
                    class="pl-6 pr-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-medium flex items-center
                    rounded-md hover:shadow-md hover:from-indigo-700 hover:to-purple-700 transition-all duration:300 shadow-sm">
                    <span>Next</span>
                    
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" class="-ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" />
                    </svg>   
                </button>

                
                <ng-template #dosubmit >
                    <div class="flex flex-col items-center relative">
                        <button 
                            class="px-6 py-2.5 bg-gray-300 text-gray-600 font-medium peer rounded-md cursor-default">
                            Submit
                        </button>
                        <div
                            class="absolute invisible top-10 peer-hover:visible text-nowrap transition-all duration-100 text-white text-xs px-2 py-1 rounded-md bg-gray-700 bg-opacity-70">
                            You cannot submit a form in preview mode
                        </div>
                    </div>
                </ng-template>
            </div>
        </div>
    </form>
</div>